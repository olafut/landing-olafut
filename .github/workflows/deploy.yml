name: Build and Deploy from Notion

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: Build y validaciÃ³n cuando se abre o actualiza un PR
  build-and-validate:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main

      - name: Build Next.js app
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: pnpm build

      - name: Commit downloaded images to PR branch
        run: |
          git add public/assets/blog/

          if ! git diff --staged --quiet; then
            git commit -m "chore: add downloaded images from Notion"
            git push origin HEAD:${{ github.head_ref }}
            echo "âœ… ImÃ¡genes descargadas commiteadas a la rama del PR"
          else
            echo "â„¹ï¸ No hay cambios nuevos en imÃ¡genes"
          fi

      - name: Verify build output
        run: |
          if [ ! -d "out" ]; then
            echo "âŒ Error: La carpeta 'out' no existe despuÃ©s del build"
            exit 1
          fi
          echo "âœ… Build verificado correctamente"
          echo "ğŸ“¦ Contenido de out:"
          ls -lah out

      - name: Comment validation success on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Build y validaciÃ³n completados exitosamente**\n\nğŸ“¦ Las imÃ¡genes de Notion han sido descargadas y commiteadas\nğŸš€ El sitio estÃ¡ listo para desplegarse cuando se cierre el PR'
            })

  # Job 2: Deploy a la rama static SOLO cuando se cierra (merge) el PR
  deploy-to-static:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Check if user is authorized to merge
        run: |
          AUTHORIZED_USERS=("olafut" "dorixdev")
          MERGER="${{ github.event.pull_request.merged_by.login }}"

          if [[ " ${AUTHORIZED_USERS[@]} " =~ " ${MERGER} " ]]; then
            echo "âœ… Usuario autorizado para merge: $MERGER"
          else
            echo "âš ï¸ Usuario que hizo merge: $MERGER"
            echo "âš ï¸ Este workflow continuarÃ¡, pero considera configurar branch protection rules"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main

      - name: Build Next.js app for production
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: pnpm build

      - name: Deploy to static branch
        run: |
          # Crear directorio temporal
          TEMP_DIR=$(mktemp -d)
          cp -r out/* "$TEMP_DIR/"

          # Trabajar en directorio temporal
          WORK_DIR=$(mktemp -d)
          cd "$WORK_DIR"

          # Inicializar repositorio
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          # Traer rama static si existe
          git fetch origin static 2>/dev/null || true

          # Crear rama huÃ©rfana
          git checkout --orphan static

          # Copiar contenido
          cp -r "$TEMP_DIR"/* .

          # Agregar archivos
          git add -A

          # Verificar y commitear si hay cambios
          if ! git diff --staged --quiet; then
            git commit -m "Deploy from PR #${{ github.event.pull_request.number }} - Merged by @${{ github.event.pull_request.merged_by.login }}"
            git push -f origin static
            echo "âœ… Desplegado exitosamente a static"
          else
            echo "â„¹ï¸ No hay cambios para desplegar"
          fi

      - name: Comment deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ **Deploy completado exitosamente**\n\nâœ… Los cambios han sido desplegados a la rama `static`\nğŸŒ El sitio en producciÃ³n ha sido actualizado'
            })
