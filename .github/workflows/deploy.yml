name: Build and Deploy from Notion

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # ‚úÖ CONFIGURAR GIT UNA SOLA VEZ AQU√ç, ANTES DE TODO
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main

      - name: Update trigger file with current date
        run: |
          # Configurar timezone para Ciudad de M√©xico
          export TZ=America/Mexico_City

          # Obtener componentes de fecha
          MONTH_NUM=$(date +%-m)
          DAY=$(date +%-d)
          YEAR=$(date +%Y)
          TIME=$(date +%H:%M)

          # Traducir mes a espa√±ol
          case $MONTH_NUM in
            1) MONTH="enero" ;;
            2) MONTH="febrero" ;;
            3) MONTH="marzo" ;;
            4) MONTH="abril" ;;
            5) MONTH="mayo" ;;
            6) MONTH="junio" ;;
            7) MONTH="julio" ;;
            8) MONTH="agosto" ;;
            9) MONTH="septiembre" ;;
            10) MONTH="octubre" ;;
            11) MONTH="noviembre" ;;
            12) MONTH="diciembre" ;;
          esac

          # Crear el contenido del archivo con el formato deseado
          cat > trigger.txt << EOF
          Fecha de √∫ltima modificaci√≥n:

          $DAY de $MONTH de $YEAR, $TIME hrs
          EOF

          echo "‚úÖ Archivo trigger.txt actualizado con la fecha: $DAY de $MONTH de $YEAR, $TIME hrs (CDMX)"

      - name: Build Next.js app
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: pnpm build

      - name: Commit trigger file and downloaded images to PR branch
        run: |
          git add trigger.txt public/assets/blog/

          if ! git diff --staged --quiet; then
            git commit -m "chore: update trigger file and add downloaded images from Notion"
            git push origin HEAD:${{ github.head_ref }}
            echo "‚úÖ Archivo trigger e im√°genes commiteadas a la rama del PR"
          else
            echo "‚ÑπÔ∏è No hay cambios nuevos"
          fi

      - name: Verify build output
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå Error: La carpeta 'out' no existe despu√©s del build"
            exit 1
          fi
          echo "‚úÖ Carpeta out verificada"
          ls -lah out

      - name: Deploy to static branch
        run: |
          # Crear directorio temporal
          TEMP_DIR=$(mktemp -d)
          cp -r out/* "$TEMP_DIR/"

          # Trabajar en directorio temporal
          WORK_DIR=$(mktemp -d)
          cd "$WORK_DIR"

          # Inicializar repositorio (ya no necesita configurar git aqu√≠)
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          # Traer rama static si existe
          git fetch origin static 2>/dev/null || true

          # Crear rama hu√©rfana
          git checkout --orphan static

          # Copiar contenido
          cp -r "$TEMP_DIR"/* .

          # Agregar archivos
          git add -A

          # Verificar y commitear si hay cambios
          if ! git diff --staged --quiet; then
            git commit -m "Deploy from PR #${{ github.event.pull_request.number }} (${GITHUB_SHA::7})"
            git push -f origin static
            echo "‚úÖ Desplegado exitosamente a static"
          else
            echo "‚ÑπÔ∏è No hay cambios para desplegar"
          fi

      - name: Comment deployment info on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Build completado exitosamente**\n\nüöÄ Los cambios est√°n desplegados en la rama `static`\nüì¶ Las im√°genes de Notion han sido descargadas y commiteadas a este PR'
            })
